<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>后台管理</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .back-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: var(--primary-hover);
    }

    .section {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .section h2 {
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
    }

    /* 公告编辑 */
    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .form-col {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: white;
      color: var(--text);
      font-size: 14px;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 60px;
    }

    /* 品类管理 */
    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .category-item {
      background: #f1f5f9;
      padding: 8px 16px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 120px;
    }

    .category-name {
      cursor: pointer;
      flex: 1;
      text-align: left;
      color: var(--text);
      font-weight: 500;
    }

    .category-name:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    .category-item button {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .add-category-form {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .add-category-form input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: white;
      color: var(--text);
      font-size: 15px;
    }

    .add-category-form button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .add-category-form button:hover {
      background: var(--primary-hover);
    }

    /* 游戏表格 */
    .platform-group {
      margin-bottom: 32px;
    }

    .platform-title {
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--primary);
      font-size: 16px;
    }

    .game-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .game-table colgroup col:nth-child(1) { width: 8%; }  /* ID */
    .game-table colgroup col:nth-child(2) { width: 8%; }  /* 封面 */
    .game-table colgroup col:nth-child(3) { width: 15%; } /* 名称 */
    .game-table colgroup col:nth-child(4) { width: 12%; } /* 平台 */
    .game-table colgroup col:nth-child(5) { width: 12%; } /* 标签 */
    .game-table colgroup col:nth-child(6) { width: 8%; }  /* 角标 */
    .game-table colgroup col:nth-child(7) { width: 10%; } /* 链接 */
    .game-table colgroup col:nth-child(8) { width: 10%; } /* 排序 */
    .game-table colgroup col:nth-child(9) { width: 17%; } /* 操作 */

    .game-table th,
    .game-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .game-table th {
      background: #f1f5f9;
      color: var(--text-muted);
      font-weight: 600;
    }

    .game-table img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 8px;
    }

    .tag-cell, .url-cell, .desc-cell {
      max-width: 120px;
      word-break: break-all;
      white-space: normal;
    }

    .edit-btn, .delete-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 6px;
    }

    .edit-btn {
      background: var(--primary);
      color: white;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
    }

    .draggable-row {
      cursor: move;
    }

    /* 悬浮按钮 */
    .admin-floating-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 999;
    }

    .floating-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      transition: background 0.2s;
    }

    .floating-btn:hover {
      background: var(--primary-hover);
    }

    .floating-btn.copy {
      background: #10b981;
    }

    .floating-btn.export {
      background: #8b5cf6;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>后台管理</h1>
    <button class="back-btn" onclick="window.location.href='index.html'">返回首页</button>
  </div>

  <!-- 公告管理 -->
  <div class="section">
    <h2>系统公告</h2>
    <div class="form-row">
      <div class="form-col">
        <label>滚动公告内容</label>
        <input type="text" class="form-control" id="announcementInput" placeholder="例如：新游戏上线！">
      </div>
      <div class="form-col">
        <label>&nbsp;</label>
        <button class="floating-btn" style="width:auto;" onclick="saveAnnouncement()">保存公告</button>
      </div>
    </div>
  </div>

  <!-- 品类管理 -->
  <div class="section">
    <h2>品类管理（平台）</h2>
    <div class="add-category-form">
      <input type="text" id="newCategoryName" placeholder="输入新品类名称（如：索尼）" />
      <button onclick="addCategory()">添加品类</button>
    </div>
    <div class="category-list" id="categoryList">
      <!-- 动态生成 -->
    </div>
  </div>

  <!-- 游戏管理 -->
  <div class="section">
    <h2>游戏管理（可拖拽排序）</h2>
    <div id="gameFormContainer">
      <!-- 动态表单 -->
    </div>
    <div id="gameGroups">
      <!-- 按平台分组渲染 -->
    </div>
  </div>

  <!-- 右下角悬浮按钮 -->
  <div class="admin-floating-buttons">
    <button class="floating-btn export" onclick="exportJson()">导出 game.json</button>
    <button class="floating-btn copy" onclick="copyJsonData()">复制 JSON 数据</button>
  </div>

  <script>
    let data = {
      meta: {},
      categories: [],
      games: []
    };

    // 加载数据
    async function loadData() {
      try {
        const res = await fetch('game.json');
        if (!res.ok) throw new Error('无法加载 game.json');
        data = await res.json();

        // 填充公告
        if (data.meta?.announcement) {
          document.getElementById('announcementInput').value = data.meta.announcement;
        }

        renderCategories();
        renderGames();
      } catch (err) {
        console.error(err);
        alert('加载数据失败，请检查 game.json 是否存在或格式正确。');
      }
    }

    // 保存公告
    function saveAnnouncement() {
      const text = document.getElementById('announcementInput').value.trim();
      data.meta = data.meta || {};
      data.meta.announcement = text;
      alert('公告已保存');
    }

    // 渲染品类
    function renderCategories() {
      const list = document.getElementById('categoryList');
      list.innerHTML = '';
      data.categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.innerHTML = `
          <span class="category-name" onclick="editCategoryName('${cat.id}', this)">${cat.name}</span>
          <button onclick="deleteCategory('${cat.id}')">删除</button>
        `;
        list.appendChild(item);
      });
    }

    function editCategoryName(id, element) {
      const currentName = element.textContent;
      const newName = prompt('编辑品类名称：', currentName);
      if (newName !== null && newName.trim() !== '' && newName !== currentName) {
        const cat = data.categories.find(c => c.id === id);
        if (cat) {
          cat.name = newName.trim();
          renderCategories();
          renderGames();
        }
      }
    }

    function addCategory() {
      const name = document.getElementById('newCategoryName').value.trim();
      if (!name) {
        alert('请输入品类名称');
        return;
      }
      const newId = 'cat_' + Date.now();
      data.categories.push({ id: newId, name: name });
      renderCategories();
      document.getElementById('newCategoryName').value = '';
    }

    function deleteCategory(id) {
      if (confirm('确定删除该品类？所有关联游戏将失去品类归属！')) {
        data.categories = data.categories.filter(c => c.id !== id);
        data.games.forEach(g => {
          if (g.category === id) g.category = '';
        });
        renderCategories();
        renderGames();
      }
    }

    // 获取最大排序值
    function getMaxOrder() {
      if (data.games.length === 0) return 0;
      return Math.max(...data.games.map(g => g.customOrder || 0));
    }

    // 渲染游戏
    function renderGames() {
      const container = document.getElementById('gameGroups');
      container.innerHTML = '';

      const groups = {};
      data.categories.forEach(cat => {
        groups[cat.id] = { ...cat, games: [] };
      });
      groups[''] = { name: '未分类', games: [] };

      data.games.forEach(game => {
        const key = game.category || '';
        if (!groups[key]) {
          groups[key] = { name: '未知', games: [] };
        }
        groups[key].games.push(game);
      });

      Object.values(groups).forEach(group => {
        group.games.sort((a, b) => (a.customOrder || 0) - (b.customOrder || 0));
      });

      Object.entries(groups).forEach(([key, group]) => {
        if (group.games.length === 0) return;

        const groupDiv = document.createElement('div');
        groupDiv.className = 'platform-group';

        const title = document.createElement('div');
        title.className = 'platform-title';
        title.textContent = `【${group.name}】`;
        groupDiv.appendChild(title);

        const table = document.createElement('table');
        table.className = 'game-table';

        table.innerHTML = `
          <colgroup>
            <col><col><col><col><col><col><col><col><col>
          </colgroup>
          <thead>
            <tr>
              <th>ID</th>
              <th>封面</th>
              <th>名称</th>
              <th>平台</th>
              <th>标签</th>
              <th>角标</th>
              <th>链接</th>
              <th>排序</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody-${key}">
          </tbody>
        `;

        const tbody = table.querySelector(`#tbody-${key}`);
        group.games.forEach(game => {
          const row = document.createElement('tr');
          row.className = 'draggable-row';
          row.draggable = true;
          row.dataset.id = game.id;

          const platformName = data.categories.find(c => c.id === game.category)?.name || '未分类';

          row.innerHTML = `
            <td>${game.id}</td>
            <td><img src="${game.image || ''}" alt="封面"></td>
            <td>${game.name}</td>
            <td>${platformName}</td>
            <td class="tag-cell">${game.tags?.join(', ') || ''}</td>
            <td>${game.badge || ''}</td>
            <td class="url-cell">${game.url || ''}</td>
            <td>${game.customOrder || 0}</td>
            <td>
              <button class="edit-btn" onclick="editGame('${game.id}')">编辑</button>
              <button class="delete-btn" onclick="deleteGame('${game.id}')">删除</button>
            </td>
          `;

          row.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', game.id);
            row.style.opacity = '0.6';
          });

          row.addEventListener('dragend', () => {
            row.style.opacity = '1';
          });

          tbody.appendChild(row);
        });

        tbody.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        tbody.addEventListener('drop', (e) => {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData('text/plain');
          const targetRow = e.target.closest('tr');
          if (!targetRow || targetRow.dataset.id === draggedId) return;

          const draggedRow = document.querySelector(`[data-id="${draggedId}"]`);
          if (!draggedRow) return;

          tbody.insertBefore(draggedRow, targetRow);
          recalculateOrderForGroup(tbody, key);
        });

        groupDiv.appendChild(table);
        container.appendChild(groupDiv);
      });

      renderGameForm(null);
    }

    function recalculateOrderForGroup(tbody, categoryId) {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach((row, index) => {
        const id = row.dataset.id;
        const game = data.games.find(g => g.id === id);
        if (game) {
          game.customOrder = index + 1;
        }
      });
    }

    // 渲染表单
    function renderGameForm(gameId) {
      const container = document.getElementById('gameFormContainer');
      const isEdit = gameId !== null;
      const game = isEdit ? data.games.find(g => g.id === gameId) : null;

      const platforms = data.categories.map(c => 
        `<option value="${c.id}" ${game && game.category === c.id ? 'selected' : ''}>${c.name}</option>`
      ).join('');

      const defaultOrder = isEdit ? (game.customOrder || 0) : (getMaxOrder() + 1);

      container.innerHTML = `
        <div class="form-row">
          <div class="form-col">
            <label>游戏名称</label>
            <input type="text" class="form-control" id="gameName" value="${game ? game.name : ''}">
          </div>
          <div class="form-col">
            <label>图片 URL</label>
            <input type="text" class="form-control" id="gameImage" value="${game ? game.image : ''}">
          </div>
          <div class="form-col">
            <label>平台</label>
            <select class="form-control" id="gameCategory">
              <option value="">-- 选择平台 --</option>
              ${platforms}
            </select>
          </div>
          <div class="form-col">
            <label>标签（逗号分隔）</label>
            <input type="text" class="form-control" id="gameTags" value="${game ? game.tags?.join(', ') : ''}">
          </div>
          <div class="form-col">
            <label>角标标签（如 VR、新）</label>
            <input type="text" class="form-control" id="gameBadge" value="${game ? (game.badge || '') : ''}">
          </div>
          <div class="form-col">
            <label>游戏链接（URL）</label>
            <input type="text" class="form-control" id="gameUrl" value="${game ? (game.url || '') : ''}">
          </div>
          <div class="form-col">
            <label>游戏介绍（留空则不显示）</label>
            <textarea class="form-control" id="gameDescription" rows="3">${game ? (game.description || '') : ''}</textarea>
          </div>
          <div class="form-col">
            <label>自定义排序</label>
            <input type="number" class="form-control" id="gameOrder" value="${defaultOrder}">
          </div>
        </div>
        <button class="floating-btn" style="width:auto;" onclick="${isEdit ? `saveGame('${gameId}')` : 'addNewGame()'}">
          ${isEdit ? '保存修改' : '添加新游戏'}
        </button>
        ${isEdit ? `<button class="floating-btn copy" style="width:auto; margin-left:12px;" onclick="cancelEdit()">取消</button>` : ''}
      `;
    }

    function editGame(id) {
      renderGameForm(id);
    }

    function cancelEdit() {
      renderGameForm(null);
    }

    function saveGame(id) {
      const name = document.getElementById('gameName').value.trim();
      const image = document.getElementById('gameImage').value.trim();
      const category = document.getElementById('gameCategory').value;
      const tags = document.getElementById('gameTags').value.split(',').map(t => t.trim()).filter(t => t);
      const badge = document.getElementById('gameBadge').value.trim();
      const url = document.getElementById('gameUrl').value.trim();
      const description = document.getElementById('gameDescription').value.trim();
      const order = parseInt(document.getElementById('gameOrder').value) || 0;

      if (!name) {
        alert('请输入游戏名称');
        return;
      }

      const game = data.games.find(g => g.id === id);
      if (game) {
        game.name = name;
        game.image = image;
        game.category = category;
        game.tags = tags;
        game.badge = badge;
        game.url = url;
        game.description = description;
        game.customOrder = order;
        renderGames();
      }
    }

    function addNewGame() {
      const name = document.getElementById('gameName').value.trim();
      const image = document.getElementById('gameImage').value.trim();
      const category = document.getElementById('gameCategory').value;
      const tags = document.getElementById('gameTags').value.split(',').map(t => t.trim()).filter(t => t);
      const badge = document.getElementById('gameBadge').value.trim();
      const url = document.getElementById('gameUrl').value.trim();
      const description = document.getElementById('gameDescription').value.trim();
      const order = parseInt(document.getElementById('gameOrder').value) || (getMaxOrder() + 1);

      if (!name) {
        alert('请输入游戏名称');
        return;
      }

      const newId = 'g_' + Date.now();
      data.games.push({
        id: newId,
        name: name,
        image: image,
        category: category,
        tags: tags,
        badge: badge,
        url: url,
        description: description,
        customOrder: order
      });

      renderGames();
    }

    function deleteGame(id) {
      if (confirm('确定删除该游戏？')) {
        data.games = data.games.filter(g => g.id !== id);
        renderGames();
      }
    }

    // 导出与复制
    function exportJson() {
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'game.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function copyJsonData() {
      const jsonStr = JSON.stringify(data, null, 2);
      navigator.clipboard.writeText(jsonStr)
        .then(() => alert('JSON 数据已复制到剪贴板'))
        .catch(err => alert('复制失败，请手动复制'));
    }

    window.addEventListener('DOMContentLoaded', loadData);
  </script>

</body>
</html>
